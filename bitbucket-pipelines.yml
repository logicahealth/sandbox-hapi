# This project uses the GitFlow Workflow as defined here:
#   https://www.atlassian.com/git/tutorials/comparing-workflows#GitFlow-workflow
image: hspconsortium/hspc-ubuntu-base
clone:           # the 'clone' section
  depth: 1       # the depth, in this case the clone will contain last one commits

pipelines:
  default:
    - step:
        script:
          - echo "Please use a GitFlow branch"
          - exit 1;
  branches:
    develop:
      - step:
          name: build the source code
          caches:
            - maven
          script:
            - mvn -V -B package
#            - mvn -V -B -s settings.xml deploy -P DEPLOY-HSPC,hspc-nexus
#            - rm reference-api-webapp-multitenant/target/*-sources.jar
#            - rm reference-api-webapp-multitenant/target/*-javadoc.jar
          artifacts:
            - reference-api-webapp-multitenant/target/*.jar
      - step:
          name: build docker and upload to docker hub
          script:
            - export DOCKER_PROJECT_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
            - echo $DOCKER_PROJECT_VERSION
            - export DOCKER_IMAGE_COORDINATES="hspconsortium/api:${DOCKER_PROJECT_VERSION}"
            - echo $DOCKER_IMAGE_COORDINATES
            - docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
            - docker build -t $DOCKER_IMAGE_COORDINATES .
            - docker push $DOCKER_IMAGE_COORDINATES
      - step:
          name: update the aws task definition
          script:
            # dstu2
            - export TEMPLATE_FILE="aws/task-definition-dstu2-test.json"
            - export DOCKER_PROJECT_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
            - export DOCKER_IMAGE_COORDINATES="hspconsortium/api:${DOCKER_PROJECT_VERSION}"
            - jq ".containerDefinitions[0].image = \"$DOCKER_IMAGE_COORDINATES\"" ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"JASYPT_ENCRYPTOR_PASSWORD", "value":"'$ENC_PW_TEST'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"SPRING_PROFILES_ACTIVE", "value":"'test,multitenant,dstu2'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - cat $(echo "$TEMPLATE_FILE")
            - export TASK_RESPONSE=$(aws ecs register-task-definition --region us-east-1 --cli-input-json file://$TEMPLATE_FILE)
            - echo $TASK_RESPONSE
            - if [[ $TASK_RESPONSE =~ ^{ ]]; then echo "Successful registration"; else echo "Registation failed"; exit 1; fi
            # stu3
            - export TEMPLATE_FILE="aws/task-definition-stu3-test.json"
            - export DOCKER_PROJECT_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
            - export DOCKER_IMAGE_COORDINATES="hspconsortium/api:${DOCKER_PROJECT_VERSION}"
            - jq ".containerDefinitions[0].image = \"$DOCKER_IMAGE_COORDINATES\"" ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"JASYPT_ENCRYPTOR_PASSWORD", "value":"'$ENC_PW_TEST'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"SPRING_PROFILES_ACTIVE", "value":"'test,multitenant,stu3'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - cat $(echo "$TEMPLATE_FILE")
            - export TASK_RESPONSE=$(aws ecs register-task-definition --region us-east-1 --cli-input-json file://$TEMPLATE_FILE)
            - echo $TASK_RESPONSE
            - if [[ $TASK_RESPONSE =~ ^{ ]]; then echo "Successful registration"; else echo "Registation failed"; exit 1; fi
      - step:
          name: Update the aws service
          deployment: test
          script:
            - export AWS_TASK_DEFINITION=$(aws ecs describe-task-definition --region us-east-1 --task-definition api-dstu2-test)
            - echo $AWS_TASK_DEFINITION
            - export AWS_TASK_VERSION=$(echo $AWS_TASK_DEFINITION | jq --raw-output '.taskDefinition.revision')
            - echo $AWS_TASK_VERSION
            - export SERVICE_RESPONSE=$(aws ecs update-service --region us-east-1 --cluster sandbox-test --service api-dstu2-test --task-definition api-dstu2-test:${AWS_TASK_VERSION})
            - echo $SERVICE_RESPONSE
            - if [[ $SERVICE_RESPONSE =~ ^{ ]]; then echo "Successful update"; else echo "Update failed"; exit 1; fi
    master:
      - step:
          name: build the source code
          caches:
            - maven
          script:
            - mvn -V -B -s settings.xml deploy -P DEPLOY-HSPC,hspc-nexus
            - rm reference-api-webapp-multitenant/target/*-sources.jar
            - rm reference-api-webapp-multitenant/target/*-javadoc.jar
          artifacts:
            - reference-api-webapp-multitenant/target/*.jar
      - step:
          name: build docker and upload to docker hub
          script:
            - export DOCKER_PROJECT_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
            - echo $DOCKER_PROJECT_VERSION
            - export DOCKER_IMAGE_COORDINATES="hspconsortium/api:${DOCKER_PROJECT_VERSION}"
            - echo $DOCKER_IMAGE_COORDINATES
            - docker login -u $DOCKER_HUB_USERNAME -p $DOCKER_HUB_PASSWORD
            - docker build -t $DOCKER_IMAGE_COORDINATES .
            - docker push $DOCKER_IMAGE_COORDINATES
      - step:
          name: update the aws task definition
          script:
            # dstu2
            - export TEMPLATE_FILE="aws/task-definition-dstu2-prod.json"
            - export DOCKER_PROJECT_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
            - export DOCKER_IMAGE_COORDINATES="hspconsortium/api:${DOCKER_PROJECT_VERSION}"
            - jq ".containerDefinitions[0].image = \"$DOCKER_IMAGE_COORDINATES\"" ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"JASYPT_ENCRYPTOR_PASSWORD", "value":"'$ENC_PW_PROD'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"SPRING_PROFILES_ACTIVE", "value":"'prod,multitenant,dstu2'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - cat $(echo "$TEMPLATE_FILE")
            - TASK_RESPONSE=$(aws ecs register-task-definition --region us-east-1 --cli-input-json file://$TEMPLATE_FILE)
            - echo $TASK_RESPONSE
            - if [[ $TASK_RESPONSE =~ ^{ ]]; then echo "Successful registration"; else echo "Registation failed"; exit 1; fi
            # stu3
            - export TEMPLATE_FILE="aws/task-definition-stu3-prod.json"
            - export DOCKER_PROJECT_VERSION=$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)
            - export DOCKER_IMAGE_COORDINATES="hspconsortium/api:${DOCKER_PROJECT_VERSION}"
            - jq ".containerDefinitions[0].image = \"$DOCKER_IMAGE_COORDINATES\"" ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"JASYPT_ENCRYPTOR_PASSWORD", "value":"'$ENC_PW_PROD'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - jq '.containerDefinitions[0].environment += [{"name":"SPRING_PROFILES_ACTIVE", "value":"'prod,multitenant,stu3'"}]' ${TEMPLATE_FILE} > tmp.json && mv tmp.json ${TEMPLATE_FILE}
            - cat $(echo "$TEMPLATE_FILE")
            - TASK_RESPONSE=$(aws ecs register-task-definition --region us-east-1 --cli-input-json file://$TEMPLATE_FILE)
            - echo $TASK_RESPONSE
            - if [[ $TASK_RESPONSE =~ ^{ ]]; then echo "Successful registration"; else echo "Registation failed"; exit 1; fi
      - step:
          name: Update the aws service
          deployment: production
          trigger: manual
          script:
            - export AWS_TASK_DEFINITION=$(aws ecs describe-task-definition --region us-east-1 --task-definition api-dstu2-prod)
            - echo $AWS_TASK_DEFINITION
            - export AWS_TASK_VERSION=$(echo $AWS_TASK_DEFINITION | jq --raw-output '.taskDefinition.revision')
            - echo $AWS_TASK_VERSION
            - SERVICE_RESPONSE=$(aws ecs update-service --region us-east-1 --cluster sandbox-prod --service api-dstu2-prod --task-definition api-dstu2-prod:${AWS_TASK_VERSION})
            - echo $SERVICE_RESPONSE
            - if [[ $SERVICE_RESPONSE =~ ^{ ]]; then echo "Successful update"; else echo "Update failed"; exit 1; fi
    feature/*:
      - step:
          caches:
            - maven
          script:
            - mvn -B verify
    release/*:
      - step:
          caches:
            - maven
          script:
            - mvn -B verify
    hotfix/*:
      - step:
          caches:
            - maven
          script:
            - mvn -B verify
options:
  docker: true